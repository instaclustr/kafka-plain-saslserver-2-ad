---
name: Gradle Package

on:
  push:
    branches:
      - main
  
  pull_request:
    paths:
      - '**/*.gradle' # Adjust the path pattern to match your Gradle files
      - '**/*.properties' # Adjust the path pattern to match your properties files
    types:
      - synchronize

jobs:
  build:
    name: Gradle Package

    runs-on: ubuntu-20.04

    permissions:
      contents: read
      packages: write


    strategy:
      matrix:
        kafka_version:
          - '3.6.0'
          - 'latest_version_here'
          - 'another_version_here'

    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.1

    - name: Set up JDK 11
      uses: actions/setup-java@v3.13.0
      with:
        java-version: '11'
        distribution: 'temurin'
        server-id: github
        settings-path: ${{ github.workspace }}
        
    - name: Get Updated Kafka Version
      id: get_kafka_version
      run: |
        PR_NUMBER=$(echo "${{ github.event_name }}" | jq --raw-output .pull_request.number)
        KAFKA_VERSION=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" \
            | jq --raw-output .head.repo_item.version)

        echo "Kafka version from Dependabot: $KAFKA_VERSION"
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Set Gradle Properties
      run: ./gradlew -P kafka_version=${{ env.KAFKA_VERSION }} clean build

    - name: Publish to GitHub Packages
      uses: gradle/gradle-build-action@v2.9.0
      with:
        arguments: publish
      env:
        USERNAME: ${{ github.actor }}
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
